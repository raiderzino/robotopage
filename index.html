<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>JavaScript Песочница</title>
</head>
<body>
    <textarea id="codeInput" rows="10" cols="50" placeholder="Введите ваш JavaScript код..."></textarea>
    <br>
    <button onclick="runCode()">Выполнить</button>
    <button onclick="showSystemInfo()">Показать информацию о системе</button>
    <button onclick="checkPackages()">Проверить доступные пакеты</button>
    <button onclick="exploreWebView()">Исследовать WebView</button>
    <button onclick="testPostMessage()">Тест postMessage</button>
    <button onclick="testIBGManager()">Тест ibg_js_manager</button>
    <button onclick="clearCacheAndReload()">Перезагрузить с очисткой кэша</button>
    <div id="output"></div>
    <h3>Запуск системных приложений через Intent</h3>
    <ul>
        <li><a href="intent:#Intent;component=com.android.settings/.DevelopmentSettings;end">Открыть настройки разработчика</a></li>
        <li><a href="intent:#Intent;component=com.android.settings/.wifi.WifiSettings;end">Открыть настройки Wi-Fi</a></li>
        <li><a href="intent:#Intent;component=com.android.settings/.Settings;end">Открыть системные настройки</a></li>
        <li><a href="intent:#Intent;component=com.android.settings/.DeviceInfoSettings;end">Открыть информацию об устройстве</a></li>
        <li><a href="intent:#Intent;package=com.dji.go;action=android.intent.action.MAIN;end">Открыть приложение DJI Go</a></li>
        <li><a href="intent:#Intent;package=com.dji.go.v4;action=android.intent.action.MAIN;end">Открыть приложение DJI Go 4</a></li>
        <li><a href="intent:#Intent;package=com.dji.rc;action=android.intent.action.MAIN;end">Открыть приложение DJI RC</a></li>
        <li><a href="intent:#Intent;package=com.dji.settings;action=android.intent.action.MAIN;end">Открыть DJI Settings</a></li>
        <li><a href="intent:#Intent;component=com.android.packageinstaller/.PackageInstallerActivity;end">Открыть установщик пакетов</a></li>
        <li><a href="intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.HOME;end">Запустить системный лаунчер</a></li>
        <li><a href="intent:#Intent;action=android.intent.action.MAIN;category=android.intent.category.PREFERENCE;end">Открыть все настройки</a></li>
        <li><a href="dji://settings">Открыть DJI Settings (custom URI)</a></li>
        <li><a href="dji://home">Открыть DJI Home (custom URI)</a></li>
        <li><a href="dji://support">Открыть DJI Support (custom URI)</a></li>
        <li><a href="djifly://settings">Открыть DJI Fly Settings (custom URI)</a></li>
        <li><a href="djifly://openSettings">Открыть DJI Fly OpenSettings (custom URI)</a></li>
        <li><a href="djifly://app">Открыть DJI Fly App (custom URI)</a></li>
        <li><a href="intent:#Intent;package=com.android.vending;action=android.intent.action.VIEW;end">Открыть Google Play</a></li>
        <li><a href="market://details?id=com.android.vending">Открыть Google Play через market</a></li>
        <li><a href="market://details?id=com.teslacoilsw.launcher">Установить Nova Launcher</a></li>
    </ul>

    <script>
        function runCode() {
            const code = document.getElementById('codeInput').value;
            const output = document.getElementById('output');
            output.innerHTML = '';

            try {
                const result = new Function(code)();
                if (result !== undefined) {
                    output.innerHTML = String(result);
                }
            } catch (error) {
                output.innerHTML = 'Ошибка: ' + error.message;
            }
        }

        function showSystemInfo() {
            const output = document.getElementById('output');
            output.innerHTML = `
                <strong>Информация о системе:</strong><br>
                Платформа: ${navigator.platform}<br>
                Операционная система: ${navigator.oscpu || 'Недоступно'}<br>
                Браузер: ${navigator.userAgent}<br>
                Язык браузера: ${navigator.language}<br>
                Разрешение экрана: ${window.screen.width}x${window.screen.height}<br>
                Цветовая глубина: ${window.screen.colorDepth} бит<br>
                Часовой пояс: ${Intl.DateTimeFormat().resolvedOptions().timeZone}<br>
                Дата и время: ${new Date().toLocaleString()}
            `;
        }

        function checkPackages() {
            const output = document.getElementById('output');
            output.innerHTML = 'Попытка проверить доступные пакеты...';
            const packages = [
                'com.android.settings',
                'com.dji.go',
                'com.dji.go.v4',
                'com.dji.rc',
                'com.dji.settings',
                'com.android.packageinstaller',
                'com.android.systemui',
                'com.android.vending'
            ];
            output.innerHTML += '<br><strong>Результаты проверки:</strong><br>';
            packages.forEach(pkg => {
                try {
                    const intent = `intent:#Intent;package=${pkg};action=android.intent.action.MAIN;end`;
                    const a = document.createElement('a');
                    a.href = intent;
                    a.click();
                    output.innerHTML += `${pkg}: Intent отправлен (проверьте, открылось ли приложение)<br>`;
                } catch (error) {
                    output.innerHTML += `${pkg}: Ошибка - ${error.message}<br>`;
                }
            });
            output.innerHTML += '<br>Если ничего не открылось, DJI лаунчер блокирует Intent. Попробуйте ссылки ниже или подключение через ПК.';
        }

        function exploreWebView() {
            const output = document.getElementById('output');
            output.innerHTML = 'Исследование WebView...<br>';
            try {
                output.innerHTML += `<strong>User Agent:</strong> ${navigator.userAgent}<br>`;
                output.innerHTML += `<strong>Location:</strong> ${window.location.href}<br>`;
                output.innerHTML += `<strong>Window Objects:</strong> ${Object.keys(window).join(', ')}<br>`;
                output.innerHTML += `<strong>Navigator Objects:</strong> ${Object.keys(navigator).join(', ')}<br>`;
                output.innerHTML += `<strong>IBG JS Manager:</strong> ${typeof window.ibg_js_manager !== 'undefined' ? JSON.stringify(window.ibg_js_manager) : 'Не найден'}<br>`;
                output.innerHTML += `<br>Попробуйте открыть консоль (Ctrl+Shift+J) и выполните: <code>console.log(window.ibg_js_manager)</code> для дополнительной информации.<br>`;
            } catch (error) {
                output.innerHTML += `Ошибка: ${error.message}<br>`;
            }
        }

        function testPostMessage() {
            const output = document.getElementById('output');
            output.innerHTML = 'Тест postMessage...<br>';
            try {
                const messages = [
                    { action: 'openSettings' },
                    { action: 'openDJISettings' },
                    { action: 'launchApp', package: 'com.android.settings' },
                    { action: 'launchApp', package: 'com.dji.go' },
                    { action: 'open', uri: 'djifly://settings' },
                    { action: 'navigate', uri: 'intent:#Intent;component=com.android.settings/.DevelopmentSettings;end' },
                    { ibg_js_manager: 'openInBrowser', uri: 'market://details?id=com.android.vending' },
                    { ibg_js_manager: 'user_login' }
                ];
                messages.forEach(msg => {
                    window.postMessage(JSON.stringify(msg), '*');
                    output.innerHTML += `Отправлено сообщение: ${JSON.stringify(msg)}<br>`;
                });
                output.innerHTML += '<br>Проверьте, вызвало ли это реакцию в DJI Fly. Если нет, WebView может не обрабатывать postMessage.';
            } catch (error) {
                output.innerHTML += `Ошибка: ${error.message}<br>`;
            }
        }

        function testIBGManager() {
            const output = document.getElementById('output');
            output.innerHTML = 'Тест ibg_js_manager...<br>';
            try {
                if (typeof window.ibg_js_manager !== 'undefined') {
                    output.innerHTML += `ibg_js_manager найден: ${JSON.stringify(window.ibg_js_manager)}<br>`;
                    const methods = Object.keys(window.ibg_js_manager);
                    output.innerHTML += `Методы ibg_js_manager: ${methods.join(', ') || 'Нет методов'}<br>`;
                    const testMethods = ['app_upload_photo', 'getCraftSn', 'getGimbalSn', 'onC1RequestFinish', 'onCareCheckoutFinish', 'onGetProductInfo', 'openInBrowser', 'user_login', 'user_logout'];
                    testMethods.forEach(method => {
                        if (typeof window.ibg_js_manager[method] === 'function') {
                            try {
                                const args = method === 'openInBrowser' ? [
                                    'https://www.google.com',
                                    'market://details?id=com.teslacoilsw.launcher',
                                    'intent:#Intent;component=com.android.settings/.DevelopmentSettings;end',
                                    'djifly://settings'
                                ] : ['test', '', 'com.android.settings'];
                                args.forEach(arg => {
                                    try {
                                        const result = window.ibg_js_manager[method](arg);
                                        output.innerHTML += `Вызван ${method}('${arg}'): ${JSON.stringify(result)}<br>`;
                                    } catch (e) {
                                        output.innerHTML += `Ошибка при вызове ${method}('${arg}'): ${e.message}<br>`;
                                    }
                                });
                            } catch (e) {
                                output.innerHTML += `Ошибка при вызове ${method}: ${e.message}<br>`;
                            }
                        } else {
                            output.innerHTML += `${method} не является функцией в ibg_js_manager.<br>`;
                        }
                    });
                } else {
                    output.innerHTML += 'ibg_js_manager не найден.<br>';
                }
                output.innerHTML += '<br>Откройте консоль (Ctrl+Shift+J) и выполните: <code>console.log(window.ibg_js_manager)</code> для деталей.';
            } catch (error) {
                output.innerHTML += `Ошибка: ${error.message}<br>`;
            }
        }

        function clearCacheAndReload() {
            const output = document.getElementById('output');
            output.innerHTML = 'Перезагрузка с очисткой кэша...<br>';
            try {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload(true);
                const timestamp = new Date().getTime();
                window.location.href = window.location.href.split('?')[0] + `?nocache=${timestamp}`;
                output.innerHTML += 'Перезагрузка выполнена. Если страница не обновилась, WebView может блокировать reload.';
            } catch (error) {
                output.innerHTML += `Ошибка: ${error.message}<br>`;
            }
        }
    </script>
</body>
</html>
